<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 Firmware Update (v0.5.4)</title>
    <style>
        :root { --bg: #121212; --card: #1e1e1e; --accent: #00e5ff; --text: #e0e0e0; --success: #00c853; --error: #ff1744; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        .container { background: var(--card); padding: 30px; border-radius: 8px; width: 100%; max-width: 650px; box-shadow: 0 8px 16px rgba(0,0,0,0.6); border: 1px solid #333; }
        h1 { border-bottom: 2px solid var(--accent); padding-bottom: 10px; margin-top: 0; color: var(--accent); font-size: 1.4rem; text-transform: uppercase; letter-spacing: 1px; }
        
        .row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .full { grid-column: 1 / -1; }
        
        label { display: block; margin-bottom: 5px; font-size: 0.85rem; color: #aaa; font-weight: bold; }
        input, select { width: 100%; padding: 10px; background: #2a2a2a; border: 1px solid #444; color: #fff; border-radius: 4px; box-sizing: border-box; }
        input:focus, select:focus { border-color: var(--accent); outline: none; }
        
        button { width: 100%; padding: 12px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; text-transform: uppercase; transition: 0.2s; }
        #btnConnect { background: #333; color: var(--accent); border: 1px solid var(--accent); }
        #btnConnect:hover { background: rgba(0, 229, 255, 0.1); }
        #btnFlash { background: var(--accent); color: #000; }
        #btnFlash:disabled { background: #444; color: #777; cursor: not-allowed; }
        
        .progress-box { background: #333; height: 8px; border-radius: 4px; margin: 20px 0; overflow: hidden; }
        .progress-bar { height: 100%; width: 0%; background: var(--success); transition: width 0.1s; }
        
        #log { background: #000; font-family: 'Consolas', monospace; padding: 15px; height: 200px; overflow-y: auto; font-size: 0.8rem; border: 1px solid #333; border-radius: 4px; color: #0f0; white-space: pre-wrap; }
    </style>
</head>
<body>

<div class="container">
    <h1>ESP32 Web Flasher</h1>

    <div class="row">
        <div>
            <label>Baud Rate</label>
            <select id="baudRate">
                <option value="115200">115200 (Lento/Seguro)</option>
                <option value="460800">460800</option>
                <option value="921600" selected>921600 (R√°pido)</option>
            </select>
        </div>
        <div style="display: flex; align-items: flex-end;">
            <button id="btnConnect">üîå 1. Conectar</button>
        </div>
    </div>

    <hr style="border-color: #333; margin-bottom: 20px;">

    <div class="row">
        <div class="full">
            <label>Firmware (.bin)</label>
            <input type="file" id="fileInput" accept=".bin">
        </div>
        <div class="full">
            <label>Offset (Hex)</label>
            <input type="text" id="offset" value="0x10000" placeholder="Ex: 0x10000">
        </div>
    </div>

    <button id="btnFlash" disabled>üöÄ 2. Gravar Firmware</button>

    <div class="progress-box"><div id="bar" class="progress-bar"></div></div>
    <div id="log">Logs do sistema...</div>
</div>

<script type="module">
    import { Transport, ESPLoader } from 'https://unpkg.com/esptool-js@0.5.4/bundle.js';

    let device = null;
    let transport = null;
    let esploader = null;

    const logDiv = document.getElementById('log');
    const bar = document.getElementById('bar');
    const btnConnect = document.getElementById('btnConnect');
    const btnFlash = document.getElementById('btnFlash');

    const log = (msg) => {
        console.log(msg);
        logDiv.innerHTML += `> ${msg}\n`;
        logDiv.scrollTop = logDiv.scrollHeight;
    };

    btnConnect.onclick = async () => {
        if (!navigator.serial) return alert("Navegador incompat√≠vel. Use Chrome ou Edge Desktop.");

        try {
            log("Solicitando porta serial...");
            
            // 1. Solicita a porta
            device = await navigator.serial.requestPort();
            
            if (!device) throw new Error("Nenhum dispositivo retornado.");

            log("Porta selecionada. Configurando comunica√ß√£o...");
            
            // 2. Pega o baud rate
            const baud = parseInt(document.getElementById('baudRate').value);
            
            // 3. Terminal simplificado
            const term = { 
                clean: () => {}, 
                writeLine: (l) => log(l), 
                write: (l) => {} 
            };

            // 4. CORRETO: Cria Transport SEM abrir a porta manualmente
            // O Transport vai abrir internamente
            transport = new Transport(device, true);
            
            log("Transporte inicializado. Conectando ao ESP32...");

            // 5. Cria o ESPLoader e conecta
            esploader = new ESPLoader({
                transport: transport,
                baudrate: baud,
                terminal: term
            });

            log("Tentando handshake (pode demorar 5-10 segundos)...");
            log("üí° DICA: Se falhar, segure o bot√£o BOOT do ESP32 e tente novamente.");

            // 6. Conecta ao chip
            const chip = await esploader.main();
            
            log(`‚úÖ SUCESSO: Conectado ao ${chip}`);

            // Atualiza UI
            btnConnect.innerText = "‚úì Conectado";
            btnConnect.disabled = true;
            btnConnect.style.borderColor = "#00c853";
            btnConnect.style.color = "#00c853";
            btnFlash.disabled = false;

        } catch (e) {
            console.error("Erro detalhado:", e);
            log(`‚ùå ERRO: ${e.message}`);
            
            if (e.message.includes("Failed to execute 'open'") || e.message.includes("opening")) {
                log("‚ö†Ô∏è A porta est√° em uso. Feche: Arduino IDE, PlatformIO, Monitor Serial, etc.");
            } else if (e.message.includes("timeout") || e.message.includes("sync")) {
                log("‚ö†Ô∏è Timeout na comunica√ß√£o. Tente:");
                log("   1. Segurar o bot√£o BOOT durante a conex√£o");
                log("   2. Usar baud rate mais baixo (115200)");
                log("   3. Usar outro cabo USB");
            }
            
            // Limpeza completa
            try {
                if (transport) await transport.disconnect();
            } catch {}
            
            device = null;
            transport = null;
            esploader = null;
            
            btnConnect.disabled = false;
        }
    };

    btnFlash.onclick = async () => {
        const fileInput = document.getElementById('fileInput');
        const offsetInput = document.getElementById('offset');
        
        if(!fileInput.files[0]) return alert("Selecione o arquivo .bin!");

        const content = await fileInput.files[0].arrayBuffer();
        const offset = parseInt(offsetInput.value, 16);

        if(isNaN(offset)) return alert("Offset inv√°lido! Use formato hex como 0x10000");

        btnFlash.disabled = true;
        bar.style.width = "0%";
        bar.style.backgroundColor = "#00c853";
        
        log(`Iniciando grava√ß√£o de ${content.byteLength} bytes em ${offsetInput.value}...`);

        try {
            // Converte ArrayBuffer para string bin√°ria (formato esperado pelo esptool-js)
            const uint8Array = new Uint8Array(content);
            let binaryString = '';
            for (let i = 0; i < uint8Array.length; i++) {
                binaryString += String.fromCharCode(uint8Array[i]);
            }
            
            const fileArray = [{ 
                data: binaryString, 
                address: offset 
            }];
            
            await esploader.writeFlash({
                fileArray: fileArray,
                flashSize: "keep",
                eraseAll: false,
                compress: true,
                reportProgress: (fileIndex, written, total) => {
                    const pct = Math.round((written / total) * 100);
                    bar.style.width = `${pct}%`;
                    if (pct % 10 === 0 || pct === 100) {
                        log(`Progresso: ${pct}% (${written}/${total} bytes)`);
                    }
                }
            });

            log("‚úÖ GRAVA√á√ÉO FINALIZADA COM SUCESSO!");
            bar.style.backgroundColor = "#00c853";

            // Reset do ESP32
            log("Reiniciando ESP32...");
            await transport.setDTR(false);
            await new Promise(resolve => setTimeout(resolve, 100));
            await transport.setRTS(true);
            await new Promise(resolve => setTimeout(resolve, 100));
            await transport.setRTS(false);
            log("‚úÖ Reset conclu√≠do. Dispositivo reiniciado.");

        } catch (e) {
            console.error("Erro na grava√ß√£o:", e);
            log(`‚ùå ERRO NA GRAVA√á√ÉO: ${e.message}`);
            bar.style.backgroundColor = "#ff1744";
        } finally {
            btnFlash.disabled = false;
        }
    };
</script>

</body>
</html>
